import p from"./lib/format-bytes.js";import{optimize as m}from"svgo";import o from"files-pipeline/dist/lib/deepmerge.js";import u from"files-pipeline/dist/options/index.js";import f from"./options/index.js";import{files as c}from"files-pipeline";import{minify as l}from"csso";import{minify as d}from"html-minifier-terser";import h from"sharp";import{minify as g}from"terser";import y from"./lib/sharp-read.js";var I=(t={})=>{for(const r in t)Object.prototype.hasOwnProperty.call(t,r)&&t[r]===!0&&(t[r]=f[r]);t=o(f,t);const a=new Set;if(typeof t.path<"u")if(t.path instanceof Array||t.path instanceof Set)for(const r of t.path)a.add(r);else a.add(t.path);return{name:"astro-compress",hooks:{"astro:build:done":async()=>{for(const[r,s]of Object.entries(t))for(const n of a)await(await(await(await new c(t.logger).in(n)).by((()=>{switch(r){case"css":return"**/*.css";case"html":return"**/*.html";case"js":return"**/*.{js,mjs,cjs}";case"img":return"**/*.{avci,avcs,avif,avifs,gif,heic,heics,heif,heifs,jfif,jif,jpe,jpeg,jpg,png,raw,tiff,webp}";case"svg":return"**/*.svg";case"json":return"**/*.json";default:return""}})())).not(t.exclude)).pipeline(o(f.pipeline,{wrote:async e=>{switch(r){case"css":return l(e.buffer.toString(),s).css;case"html":return await d(e.buffer.toString(),s);case"js":{const{code:i}=await g(e.buffer.toString(),s);return i||e.buffer}case"img":return y(s,e);case"svg":{const{data:i}=m(e.buffer.toString(),s);return typeof i<"u"?i:e.buffer}case"json":return JSON.stringify(e.buffer.toString());default:return e.buffer}},read:async e=>{switch(r){case"img":return h(e.inputPath,{failOn:"none",sequentialRead:!0,unlimited:!0});default:return await u.pipeline.read(e)}},fulfilled:async e=>e.files>0?`Successfully compressed a total of ${e.files} ${r.toUpperCase()} ${e.files===1?"file":"files"} for ${await p(e.info.total)}.`:!1}))}}}};export{I as default};
