import l from"./Library/SharpRead.js";import c from"./Option/Index.js";import{minify as d}from"csso";import h,{Bytes as y,Merge as n,WalkUntilGit as S,Default as p}from"files-pipe";import{minify as w}from"html-minifier-terser";import u from"sharp";import{optimize as g}from"svgo";import{minify as P}from"terser";import{fileURLToPath as B}from"url";var L=(i={})=>{for(const a in i)Object.prototype.hasOwnProperty.call(i,a)&&i[a]===!0&&(i[a]=c[a]);const e=n(c,i),f=new Set;if(typeof e.Path<"u"&&(e.Path instanceof Array||e.Path instanceof Set))for(const a of e.Path)f.add(a);return{name:"astro-compress",hooks:{"astro:build:done":async({dir:a})=>{f.size||f.add(a),e.Cache&&e.Cache.Search===p.Cache.Search&&(e.Cache.Search=await S(B(a)));for(const[s,o]of Object.entries(e))if(o)for(const m of f)await(await(await(await new h(e.Cache,e.Logger).In(m)).By(typeof e.Map=="object"?e.Map[s]:"")).Not(e.Exclude)).Pipe(n(e.Action,n(e.Action,{Wrote:async t=>{switch(s){case"CSS":return d(t.Buffer.toString(),o).css;case"HTML":return await w(t.Buffer.toString(),o);case"JavaScript":{const{code:r}=await P(t.Buffer.toString(),o);return r||t.Buffer}case"Image":return l(o,t);case"SVG":{const{data:r}=g(t.Buffer.toString(),o);return typeof r<"u"?r:t.Buffer}default:return t.Buffer}},Read:async t=>{switch(s){case"Image":{const{format:r}=await u(t.Input).metadata();return u(t.Input,{failOn:"none",sequentialRead:!0,unlimited:!0,animated:r==="webp"||r==="gif"})}default:return await p.Action.Read(t)}},Fulfilled:async t=>t.Files>0?`Successfully compressed a total of ${t.Files} ${s} ${t.Files===1?"file":"files"} for ${await y(t.Info.Total)}.`:!1})))}}}};export{L as default};
